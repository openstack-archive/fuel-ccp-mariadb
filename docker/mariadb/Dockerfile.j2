FROM {{ image_spec("base-tools") }}
MAINTAINER {{ maintainer }}

COPY {{ render('sources.list.debian.j2') }} /etc/apt/sources.list.d/mariadb.list
COPY {{ render('apt_preferences.debian.j2') }} /etc/apt/preferences
COPY mariadb_sudoers /etc/sudoers.d/mariadb_sudoers

RUN apt-key adv --recv-keys --keyserver {{ url.mariadb.debian.keyserver }} \
    {{ url.mariadb.debian.keyid }} \
    && apt-get update \
    && apt-get install -y --force-yes --no-install-recommends percona-xtradb-cluster-57 jq \
    && chmod 750 /etc/sudoers.d \
    && chmod 440 /etc/sudoers.d/mariadb_sudoers \
    && usermod -a -G microservices mysql \
    && chown -R mysql: /etc/mysql /var/lib/mysql

USER mysql
