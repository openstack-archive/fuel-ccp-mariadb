service:
  name: mariadb
  daemonset: true
  ports:
    - {{ percona.port }}
  containers:
    - name: galera-healthcheck
      image: galera-healthcheck
      probes:
        readiness: "true"
        liveness:
          path: "true"
          type: "exec"
      daemon:
        files:
          - galera-healthcheck-entrypoint
        dependencies:
          - etcd
        #command: bash -x /entrypoint.sh
        command: python -m SimpleHTTPServer 8080
    - name: percona
      image: percona
      probes:
        readiness: "true"
        liveness:
          path: "/"
          type: "httpGet"
          port: 8080
      volumes:
        - name: mysql-logs
          path: "/var/log/ccp/mysql"
          type: host
          readOnly: False
        - name: mysql-storage
          path: "/var/lib/mysql"
          type: empty-dir
          readOnly: false
      daemon:
        files:
          - entrypoint
          - mycnf
        dependencies:
          - etcd
        command: bash /entrypoint.sh

files:
  entrypoint:
    path: /entrypoint.sh
    content: percona_entrypoint.sh.j2
  mycnf:
    path: /etc/mysql/my.cnf
    content: node.cnf.j2
  galera-healthcheck-entrypoint:
    path: /entrypoint.sh
    content: galera-healthcheck-entrypoint.sh.j2
